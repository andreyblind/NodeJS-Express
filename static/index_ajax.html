<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ajax chat</title>
	<link rel="stylesheet" href="/static/bootstrap.css">
</head>
<body>
<div class="container">
	<div class="row">
		<div class="col-md-12">

  				<div class="form-group">
			    <label for="name">Name</label>
			    <input type="text" class="form-control" id="name" placeholder="enter your name" id="name">
			  </div>
			  <div class="form-group">
			    <label for="message">Message</label>
			    <input type="text" class="form-control" id="message" placeholder="enter your message" id="message">
			  </div>
  				<button class="btn btn-default" id="send">Отправить</button>
		</div>
		<div class="col-md-12">
			<table class="table table-striped table-bordered" id="table">
			<tr>
				<td>name</td>
				<td>message</td>
			</tr>
			<tr>
				<td>name</td>
				<td>message</td>
			</tr>
			</table>
		</div>
	</div>
</div>

<script type="text/javascript">
	var ajaxChat = (function() {
		var chatEngine = {
			_msgArr: [],
			_userData: {
				name: null
			},
			_interval: null,
			_htmlControls: {},
			cont:this,
			_handlers: {
				sendMessageToServer: function(cont){
					var data = {
						userMessage:this._htmlControls.userMessage.value,
						userName:this._htmlControls.userName.value

					}
					this.postMessage(data);
				}
			},
			sendRequest: function(options) {
				var url = options.url || '/',
				method = options.method || 'GET',
				callback = options.callback || function() {
							console.info("Callback not defined!");
						},
				data = options.data || {},
				xmlHttp = new XMLHttpRequest();

				xmlHttp.open(method, url, true);
				xmlHttp.setRequestHeader('Content-Type', 'application/json');
				xmlHttp.send(JSON.stringify(data));
				xmlHttp.onreadystatechange = function() {
					if(xmlHttp.status == 200 && xmlHttp.readyState === 4) {
						callback(xmlHttp.responseText);
					}
				};
			},
			setNewData:function(data){
				console.table(data);
			},
			postMessage: function(data){
				this.sendRequest({
					url:"/messages",
					method:"post",
					data:data
				});

			},
			getMessages: function() {
				var that = this;
				this.sendRequest({
					//переписать урл в настройки
					url: '/messages',
					method: 'GET',
					callback: function(msg){
						console.table(msg);
						that.setNewData(JSON.parse(msg));

					}
				});
			},
			setControls: function(elements){
				for (var k in elements){
					var element = document.querySelector(elements[k]);
					if(element){
						this._htmlControls[k] = element;
					}
				}
				this._htmlControls.sendButton.addEventListener("click", this._handlers.sendMessageToServer.bind(this));

			},
			setTimeInterval: function(){
				var bindCallback = this.getMessages.bind(this);
				this._interval = setInterval(bindCallback, 1000);
			},
			clearTimeInterval: function(){

			}
		}

		return{
			appInit: function(elements){
				/*
				 * Первичная проверка валидности данных. дальше за данные
				 * и их достоверность будет отвечать приватный метод
				 * setControls
				 * */
				if( (typeof elements == 'object') && ( (Object.keys(elements)).length == 4) ){
					chatEngine.setControls(elements);

				}
			},
			appRun: function() {
				chatEngine.setTimeInterval();
			},
			appTerminate: function(){
// очистить интервал
			}
		}
	})();

	ajaxChat.appInit({
		userName: "#name",
		userMessage: "#message",
		sendButton: "#send",
		messageContainer: "#table"
	});

	ajaxChat.appRun();



</script>

</body>
</html>